<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Livraria Pro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* (Estilos mantidos intactos) */
        :root { --primary-color: #4361ee; --secondary-color: #3a0ca3; --accent-color: #4cc9f0; --success-color: #06d6a0; --warning-color: #ffd166; --danger-color: #ef476f; --dark-color: #1a1a2e; --light-color: #f8f9fa; --gradient-primary: linear-gradient(135deg, #4361ee 0%, #3a0ca3 100%); --sidebar-width: 260px; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: #f5f7fb; color: #333; min-height: 100vh; overflow-x: hidden; }
        .sidebar { background: white; width: var(--sidebar-width); height: 100vh; position: fixed; left: 0; top: 0; box-shadow: 5px 0 25px rgba(0, 0, 0, 0.08); z-index: 1000; display: flex; flex-direction: column; transition: all 0.3s ease; }
        .sidebar-header { padding: 1.5rem; border-bottom: 1px solid #eee; }
        .sidebar-logo { display: flex; align-items: center; gap: 12px; text-decoration: none; color: var(--dark-color); }
        .logo-icon { width: 40px; height: 40px; background: var(--gradient-primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; }
        .logo-text { font-family: 'Poppins', sans-serif; font-weight: 700; font-size: 1.3rem; }
        .logo-subtitle { font-size: 0.75rem; color: #6c757d; }
        .sidebar-menu { padding: 1.5rem 0; flex: 1; overflow-y: auto; }
        .nav-link { display: flex; align-items: center; gap: 12px; padding: 0.9rem 1.5rem; color: #495057; text-decoration: none; border-radius: 0 12px 12px 0; margin-right: 1rem; transition: all 0.3s ease; font-weight: 500; }
        .nav-link:hover, .nav-link.active { background: rgba(67, 97, 238, 0.1); color: var(--primary-color); border-left: 4px solid var(--primary-color); }
        .nav-link i { font-size: 1.2rem; width: 24px; text-align: center; }
        .sidebar-footer { padding: 1.5rem; border-top: 1px solid #eee; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 45px; height: 45px; border-radius: 50%; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
        .main-content { margin-left: var(--sidebar-width); padding: 2rem; min-height: 100vh; }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        .header-title h1 { font-family: 'Poppins', sans-serif; font-size: 2rem; font-weight: 700; color: var(--dark-color); margin-bottom: 0.5rem; }
        .header-title p { color: #6c757d; margin: 0; }
        .header-actions { display: flex; gap: 1rem; }
        .btn-modern { padding: 0.7rem 1.5rem; border-radius: 10px; border: none; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: all 0.3s ease; cursor: pointer; }
        .btn-primary-modern { background: var(--gradient-primary); color: white; }
        .btn-primary-modern:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(67, 97, 238, 0.25); }
        .btn-outline-modern { border: 2px solid var(--primary-color); color: var(--primary-color); background: transparent; }
        .btn-outline-modern:hover { background: var(--primary-color); color: white; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .stats-card { background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); transition: all 0.3s ease; display: flex; align-items: center; gap: 1.5rem; height: 100%; border-bottom: 4px solid transparent; }
        .stats-card:hover { transform: translateY(-5px); }
        .stats-icon { width: 70px; height: 70px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
        .blue { background: rgba(67, 97, 238, 0.1); color: var(--primary-color); }
        .green { background: rgba(6, 214, 160, 0.1); color: var(--success-color); }
        .orange { background: rgba(255, 209, 102, 0.1); color: var(--warning-color); }
        .red { background: rgba(239, 71, 111, 0.1); color: var(--danger-color); }
        .stats-content h3 { font-size: 1.8rem; font-weight: 700; margin: 0; line-height: 1; }
        .stats-content p { color: #6c757d; margin: 0.3rem 0 0 0; font-size: 0.9rem; }
        .charts-section { display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        .chart-card { background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); }
        .chart-container { position: relative; height: 300px; width: 100%; }
        .table-section { background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05); margin-bottom: 2rem; }
        .table-modern { width: 100%; border-collapse: separate; border-spacing: 0; }
        .table-modern th { background: #f8f9fa; color: #495057; font-weight: 600; padding: 1rem; text-align: left; }
        .table-modern td { padding: 1rem; border-bottom: 1px solid #eee; }
        .badge-modern { padding: 0.4rem 0.8rem; border-radius: 20px; font-weight: 500; font-size: 0.85rem; }
        .badge-danger { background: rgba(239, 71, 111, 0.15); color: var(--danger-color); }
        .badge-warning { background: rgba(255, 209, 102, 0.15); color: var(--warning-color); }
        @media (max-width: 992px) { .sidebar { transform: translateX(-100%); width: 280px; } .sidebar.active { transform: translateX(0); } .main-content { margin-left: 0; padding: 1rem; } .charts-section { grid-template-columns: 1fr; } .menu-toggle { display: block !important; } }
        .menu-toggle { display: none; position: fixed; top: 1rem; left: 1rem; z-index: 1001; background: var(--primary-color); color: white; border: none; width: 45px; height: 45px; border-radius: 10px; }
    </style>
</head>
<body>
    <button class="menu-toggle" id="menuToggle"><i class="bi bi-list"></i></button>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="dashboard.html" class="sidebar-logo">
                <div class="logo-icon"><i class="bi bi-book"></i></div>
                <div><div class="logo-text">Livraria Pro</div><div class="logo-subtitle">Controle de Estoque</div></div>
            </a>
        </div>
        <nav class="sidebar-menu">
            <ul class="nav flex-column">
                <li class="nav-item all-logged"><a class="nav-link active" href="dashboard.html"><i class="bi bi-speedometer2"></i> <span>Dashboard</span></a></li>
                <li class="nav-item admin"><a class="nav-link" href="cadastro-pessoas.html"><i class="bi bi-people"></i> <span>Funcionários</span></a></li>
                <li class="nav-item admin"><a class="nav-link" href="cadastro-fornecedores.html"><i class="bi bi-truck"></i> <span>Fornecedores</span></a></li>
                <li class="nav-item all-logged"><a class="nav-link" href="cadastro-produtos.html"><i class="bi bi-book"></i> <span>Cadastrar Livros</span></a></li>
                <li class="nav-item all-logged"><a class="nav-link" href="entrada-produtos.html"><i class="bi bi-arrow-down-circle"></i> <span>Entrada de Livros</span></a></li>
                <li class="nav-item all-logged"><a class="nav-link" href="saida-produtos.html"><i class="bi bi-arrow-up-circle"></i> <span>Venda de Livros</span></a></li>
                <li class="nav-item all-logged"><a class="nav-link" href="consulta-estoque.html"><i class="bi bi-search"></i> <span>Consultar Acervo</span></a></li>
                <li class="nav-item admin"><a class="nav-link" href="relatorios.html"><i class="bi bi-graph-up"></i> <span>Relatórios</span></a></li>
                <li class="nav-item mt-3"><a class="nav-link text-danger" href="#" onclick="logout()"><i class="bi bi-box-arrow-right"></i> <span>Sair</span></a></li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar" id="userAvatar">U</div>
                <div class="user-details"><h6 id="loggedUsername">...</h6><small id="loggedUserRole">...</small></div>
            </div>
        </div>
    </aside>
    
    <main class="main-content">
        <div class="dashboard-header">
            <div class="header-title">
                <h1>Dashboard - Livraria</h1>
                <p>Visão geral do seu acervo e desempenho</p>
            </div>
            <div class="header-actions">
                <button class="btn-modern btn-outline-modern" onclick="history.back()"><i class="bi bi-arrow-left"></i> Voltar</button>
                <button class="btn-modern btn-outline-modern" onclick="location.reload()"><i class="bi bi-arrow-clockwise"></i> Atualizar</button>
                <button class="btn-modern btn-primary-modern" onclick="window.location.href='cadastro-produtos.html'"><i class="bi bi-plus-circle"></i> Novo Livro</button>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stats-card" style="border-bottom-color: var(--primary-color);">
                <div class="stats-icon blue"><i class="bi bi-book"></i></div>
                <div class="stats-content"><h3 id="dashTotalTitulos">0</h3><p>Títulos no Acervo</p></div>
            </div>
            <div class="stats-card" style="border-bottom-color: var(--success-color);">
                <div class="stats-icon green"><i class="bi bi-stack"></i></div>
                <div class="stats-content"><h3 id="dashTotalExemplares">0</h3><p>Exemplares em Estoque</p></div>
            </div>
            <div class="stats-card" style="border-bottom-color: var(--warning-color);">
                <div class="stats-icon orange"><i class="bi bi-exclamation-triangle"></i></div>
                <div class="stats-content"><h3 id="dashEstoqueBaixo">0</h3><p>Estoque Baixo (< 10)</p></div>
            </div>
            <div class="stats-card" style="border-bottom-color: var(--danger-color);">
                <div class="stats-icon red"><i class="bi bi-currency-dollar"></i></div>
                <div class="stats-content"><h3 id="dashValorTotal">R$ 0,00</h3><p>Valor Total do Acervo</p></div>
            </div>
        </div>
        
        <div class="charts-section">
            <div class="chart-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Movimentação do Acervo</h4>
                    <span class="badge bg-light text-dark">Modo: Demonstração (Dados Fictícios)</span>
                </div>
                <div class="chart-container"><canvas id="movimentacaoChart"></canvas></div>
            </div>
            <div class="chart-card">
                <h4 class="mb-3">Livros por Gênero</h4>
                <div class="chart-container"><canvas id="generosChart"></canvas></div>
            </div>
        </div>
        
        <div class="table-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">Atenção: Livros com Estoque Baixo</h4>
                <a href="entrada-produtos.html" class="btn btn-sm btn-outline-primary">Repor Estoque</a>
            </div>
            <div class="table-responsive">
                <table class="table-modern">
                    <thead><tr><th>Código</th><th>Título / Produto</th><th>Gênero</th><th>Estoque Atual</th><th>Status</th><th>Ação</th></tr></thead>
                    <tbody id="tabelaEstoqueBaixo"><tr><td colspan="6" class="text-center py-4">Carregando dados...</td></tr></tbody>
                </table>
            </div>
        </div>
        <footer class="text-center text-muted mt-5 pb-3"><small>Sistema de Controle de Estoque &copy; 2025 - Livraria Pro</small></footer>
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_URL = 'http://localhost:8000/api/v1';
        let categoriasMap = {};

        function getToken() { return localStorage.getItem('access_token') || sessionStorage.getItem('access_token'); }
        function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { return null; } }
        function logout() { localStorage.clear(); sessionStorage.clear(); window.location.href = 'index.html'; }

        document.addEventListener('DOMContentLoaded', () => {
            const token = getToken();
            if (!token) { window.location.href = 'index.html'; return; }
            const user = parseJwt(token);
            if (user) {
                const nome = user.username || user.user || "Usuário";
                document.getElementById('loggedUsername').textContent = nome;
                document.getElementById('loggedUserRole').textContent = user.is_superuser ? 'Administrador' : 'Funcionário';
                if(nome.length > 0) document.getElementById('userAvatar').textContent = nome.charAt(0).toUpperCase();
            }
            document.getElementById('menuToggle').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('active'));
            carregarDadosDashboard();
        });

        async function carregarDadosDashboard() {
            try {
                const resCat = await fetch(`${API_URL}/categorias/`, { headers: { 'Authorization': `Bearer ${getToken()}` }});
                if(resCat.ok) {
                    const dadosCat = await resCat.json();
                    const listaCat = Array.isArray(dadosCat) ? dadosCat : dadosCat.results || [];
                    listaCat.forEach(c => categoriasMap[c.id] = c.nome);
                }
                const resProd = await fetch(`${API_URL}/produtos/`, { headers: { 'Authorization': `Bearer ${getToken()}` }});
                if(resProd.ok) {
                    const dadosProd = await resProd.json();
                    const produtos = Array.isArray(dadosProd) ? dadosProd : dadosProd.results || [];
                    processarDados(produtos);
                }
            } catch (error) { console.error("Erro dashboard:", error); }
        }

        function processarDados(produtos) {
            let totalTitulos = 0;
            let totalEstoque = 0;
            let valorTotal = 0;
            let produtosBaixoEstoque = [];
            let contagemGeneros = {};

            produtos.forEach(p => {
                const qtd = p.quantidade_estoque || 0;
                const preco = parseFloat(p.preco_venda || 0);
                const catNome = p.categoria_nome || categoriasMap[p.categoria] || 'Outros';

                totalTitulos++;
                totalEstoque += qtd;
                valorTotal += (qtd * preco);
                contagemGeneros[catNome] = (contagemGeneros[catNome] || 0) + 1;

                if (qtd < 10) produtosBaixoEstoque.push(p);
            });

            document.getElementById('dashTotalTitulos').textContent = totalTitulos;
            document.getElementById('dashTotalExemplares').textContent = totalEstoque;
            document.getElementById('dashEstoqueBaixo').textContent = produtosBaixoEstoque.length;
            document.getElementById('dashValorTotal').textContent = valorTotal.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

            renderizarTabelaBaixo(produtosBaixoEstoque);
            renderizarGraficoGeneros(contagemGeneros);
            renderizarGraficoMovimentacao(); // Chama a versão demonstração
        }

        function renderizarTabelaBaixo(lista) {
            const tbody = document.getElementById('tabelaEstoqueBaixo');
            tbody.innerHTML = '';
            if (lista.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-success"><i class="bi bi-check-circle"></i> Nenhum produto com estoque crítico.</td></tr>';
                return;
            }
            lista.slice(0, 5).forEach(p => {
                const cat = p.categoria_nome || categoriasMap[p.categoria] || '-';
                const qtd = p.quantidade_estoque || 0;
                let classeBadge = qtd === 0 ? 'badge-danger' : 'badge-warning';
                let textoBadge = qtd === 0 ? 'Esgotado' : 'Crítico';
                tbody.innerHTML += `<tr><td><small class="text-muted">${p.codigo_barras || '-'}</small></td><td class="fw-bold">${p.nome}</td><td>${cat}</td><td class="fw-bold text-danger">${qtd}</td><td><span class="badge-modern ${classeBadge}">${textoBadge}</span></td><td><button class="btn btn-sm btn-outline-primary" onclick="window.location.href='entrada-produtos.html'">Repor</button></td></tr>`;
            });
        }

        function renderizarGraficoGeneros(dados) {
            const ctx = document.getElementById('generosChart').getContext('2d');
            if (Object.keys(dados).length === 0) dados = {'Sem Dados': 1};
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(dados),
                    datasets: [{ data: Object.values(dados), backgroundColor: ['#4361ee', '#3a0ca3', '#4cc9f0', '#f72585', '#ffd166', '#06d6a0'], borderWidth: 0 }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { usePointStyle: true, boxWidth: 8 } } } }
            });
        }

        // === VERSÃO DEMONSTRAÇÃO (Estática) ===
        function renderizarGraficoMovimentacao() {
            const ctx = document.getElementById('movimentacaoChart').getContext('2d');
            const dadosEntrada = [15, 25, 10, 30, 20, 15, 40, 25, 30, 15, 25, 40]; 
            const dadosSaida   = [10, 20, 15, 25, 15, 10, 35, 20, 25, 12, 18, 30]; 

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'],
                    datasets: [
                        { label: 'Entradas', data: dadosEntrada, borderColor: '#06d6a0', backgroundColor: 'rgba(6, 214, 160, 0.1)', fill: true, tension: 0.4 },
                        { label: 'Saídas', data: dadosSaida, borderColor: '#ef476f', tension: 0.4 }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
            });
        }
    </script>
</body>
</html>