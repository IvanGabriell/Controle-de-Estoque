<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Controle de Estoque</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Paleta de Cores Aprimorada */
        :root {
            --primary-color: #198754; /* Novo Verde (mais profundo que o padrão) */
            --primary-light: #28a745; /* Antigo Verde como acento leve */
            --secondary-color: #f8f9fa; /* Fundo muito leve */
            --text-color: #212529; /* Texto escuro */
            --card-bg: #ffffff;
            --info-color: #0d6efd;
            --success-color: #198754;
            --danger-color: #dc3545;
        }

        body {
            background-color: var(--secondary-color);
            color: var(--text-color);
            padding-bottom: 70px;
            font-family: 'Inter', sans-serif; /* Aplica a nova fonte */
            transition: background-color 0.5s;
        }

        /* Estilo da Barra de Navegação */
        .navbar {
            background-color: var(--primary-color); /* Usa o novo verde principal */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2); /* Sombra mais destacada */
        }
        .navbar-brand, .nav-link {
            color: white !important;
            font-weight: 600;
        }
        .nav-link {
            padding: 8px 15px; /* Mais padding para melhor toque */
            border-radius: 6px;
            transition: background-color 0.3s ease;
        }
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.15); /* Efeito hover mais suave */
            transform: translateY(-1px);
        }

        /* Estilo dos Cards de Conteúdo */
        .card {
            margin: 30px auto;
            max-width: 900px; /* Levemente mais largo */
            border: none;
            border-radius: 15px; /* Bordas mais arredondadas */
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1); /* Sombra mais proeminente */
            transition: transform 0.3s ease;
        }
        .card:hover {
             /* Pequeno levantamento no hover */
            /* transform: translateY(-3px); */
        }

        .card-body {
            padding: 40px;
        }

        .card-title {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color); /* Linha divisória de cor primária */
            padding-bottom: 15px;
            margin-bottom: 25px;
            font-weight: 700;
            font-size: 1.8rem;
        }
        
        .hidden { display: none !important; }

        /* Estilo para a lista de gerenciamento de pessoas/produtos */
        .list-group-item {
            border-radius: 10px;
            margin-bottom: 10px;
            padding: 15px;
            transition: all 0.3s ease;
            border-left: 6px solid var(--primary-color); /* Destaque lateral mais grosso */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .list-group-item:hover {
            background-color: #e9ecef;
        }

        /* Estilo de Botões */
        .btn-primary {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #157347 !important; /* Escurece um pouco no hover */
            border-color: #157347 !important;
        }
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        .btn {
            border-radius: 8px;
            font-weight: 600;
            padding: 10px 20px;
            transition: all 0.3s ease;
        }

        /* Estilo de Formulário */
        .form-control {
            border-radius: 8px;
            padding: 10px 15px;
            border: 1px solid #ced4da;
        }
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25); /* Sombra de foco verde */
        }

        /* Badges de Role */
        .badge.bg-success {
            background-color: var(--primary-color) !important;
            font-weight: 600;
            padding: 6px 10px;
        }
        .badge.bg-danger {
            background-color: var(--danger-color) !important;
        }
        .badge.bg-info {
            background-color: var(--info-color) !important;
        }
        .badge.bg-secondary {
            background-color: #6c757d !important;
        }

        /* Resultado da Consulta/Relatório */
        #resultadoConsulta, #resultadoRelatorio {
            background-color: #f1f8f3;
            border: 1px solid var(--primary-light) !important;
            border-radius: 10px;
            padding: 20px !important;
            white-space: pre-wrap; /* Mantém a formatação com <br> */
        }
        
        /* Estilo do Rodapé */
        .footer {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: #e9ecef;
            color: #6c757d;
            text-align: center;
            padding: 15px 0;
            font-size: 0.9rem;
            border-top: 1px solid #dee2e6;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
            z-index: 1000;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#"> Controle de Estoque</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item all-logged"><a class="nav-link hidden" href="#" onclick="showPage('dashboard')">Dashboard</a></li>
                    <li class="nav-item admin"><a class="nav-link hidden" href="#" onclick="showPage('cadastro-pessoas')">Cadastrar Pessoas</a></li>
                    <li class="nav-item admin"><a class="nav-link hidden" href="#" onclick="showPage('cadastro-fornecedores')">Cadastrar Fornecedores</a></li>
                    <li class="nav-item admin funcionario"><a class="nav-link hidden" href="#" onclick="showPage('cadastro-produtos')">Cadastrar Produtos</a></li>
                    <li class="nav-item admin funcionario"><a class="nav-link hidden" href="#" onclick="showPage('entrada-produtos')">Entrada de Produtos</a></li>
                    <li class="nav-item admin funcionario"><a class="nav-link hidden" href="#" onclick="showPage('saida-produtos')">Saída de Produtos</a></li>
                    <li class="nav-item admin funcionario usuario"><a class="nav-link hidden" href="#" onclick="showPage('consulta-estoque')">Consultar Estoque</a></li>
                    <li class="nav-item admin"><a class="nav-link hidden" href="#" onclick="showPage('relatorios')">Relatórios</a></li>
                    <li class="nav-item all-logged"><a class="nav-link hidden" href="#" onclick="logout()">Sair (Logout)</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="login" class="card">
            <div class="card-body">
                <h2 class="card-title"> Login no Sistema</h2>
                <form id="loginForm">
                    <div class="mb-3">
                        <label for="username" class="form-label">Usuário</label>
                        <input type="text" class="form-control" id="username" required>
                        <div class="form-text">Tente: admin, funcionario, usuario (senha igual ao usuário)</div>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Senha</label>
                        <input type="password" class="form-control" id="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Entrar</button>
                </form>
                <p class="mt-4 text-center">
                    <a href="#" onclick="showPage('cadastro-pessoas')" class="btn btn-sm btn-outline-secondary">Cadastrar novo usuário</a>
                </p>
            </div>
        </div>

        <div id="dashboard" class="hidden card">
            <div class="card-body">
                <h2 class="card-title"> Dashboard de Controle</h2>
                <p>Bem-vindo(a), <strong id="loggedUsername"></strong>! Seu nível de acesso é: <span class="badge bg-success" id="loggedUserRole"></span>. Use o menu acima para gerenciar o estoque.</p>
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="p-3 bg-light rounded shadow-sm text-center">
                            <h5>Produtos Cadastrados</h5>
                            <p class="fs-2 text-primary" id="dashboardProdCount">0</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 bg-light rounded shadow-sm text-center">
                            <h5>Estoque Total (Qtd)</h5>
                            <p class="fs-2 text-success" id="dashboardStockTotal">0</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="p-3 bg-light rounded shadow-sm text-center">
                            <h5>Itens em Estoque Baixo</h5>
                            <p class="fs-2 text-danger" id="dashboardLowStock">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="cadastro-pessoas" class="hidden card">
            <div class="card-body">
                <h2 class="card-title"> Cadastro e Gerenciamento de Pessoas</h2>
                <form id="cadastroForm">
                    <div class="row">
                        <div class="col-md-4 mb-3"><label for="nome" class="form-label">Nome de Usuário</label><input type="text" class="form-control" id="nome" required></div>
                        <div class="col-md-3 mb-3"><label for="idade" class="form-label">Idade</label><input type="number" class="form-control" id="idade" min="1" required></div>
                        <div class="col-md-5 mb-3"><label for="senha" class="form-label">Criar Senha</label><input type="password" class="form-control" id="senha" minlength="6" required></div>
                    </div>
                    <div class="form-text mb-3">A senha deve ter pelo menos 6 caracteres. Novos usuários são registrados como 'usuario'.</div>
                    <button type="submit" class="btn btn-primary w-100">Cadastrar Novo Usuário</button>
                </form>
                <h4 class="mt-5 text-primary">Gerenciar Acesso (Apenas Admin)</h4>
                <ul id="listaPessoas" class="list-group mt-3"></ul>
            </div>
        </div>

        <div id="cadastro-fornecedores" class="hidden card">
            <div class="card-body">
                <h2 class="card-title"> Cadastro de Fornecedores</h2>
                <form id="fornecedorForm">
                    <div class="row">
                        <div class="col-md-6 mb-3"><label>Nome do Fornecedor/Empresa:</label><input type="text" class="form-control" id="nomeFornecedor" required></div>
                        <div class="col-md-6 mb-3"><label>CNPJ:</label><input type="text" class="form-control" id="cnpjFornecedor" required></div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3"><label>Telefone:</label><input type="text" class="form-control" id="telefoneFornecedor"></div>
                        <div class="col-md-6 mb-3"><label>Email:</label><input type="email" class="form-control" id="emailFornecedor"></div>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Cadastrar Fornecedor</button>
                </form>
                <h4 class="mt-5 text-primary">Fornecedores Cadastrados</h4>
                <ul id="listaFornecedores" class="list-group mt-3"></ul>
            </div>
        </div>
        
        <div id="cadastro-produtos" class="hidden card">
            <div class="card-body">
                <h2 class="card-title"> Cadastro de Produtos</h2>
                <form id="produtoForm">
                    <div class="row">
                        <div class="col-md-6 mb-3"><label>Nome:</label><input type="text" class="form-control" id="nomeProd" required></div>
                        <div class="col-md-6 mb-3"><label>Código (Chave Única):</label><input type="text" class="form-control" id="codigoProd" required></div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3"><label>Categoria:</label><input type="text" class="form-control" id="categoria" required></div>
                        <div class="col-md-4 mb-3"><label>Quantidade Inicial:</label><input type="number" class="form-control" id="quantidade" min="0" required></div>
                        <div class="col-md-4 mb-3"><label>Preço Unitário (R$):</label><input type="number" class="form-control" id="preco" step="0.01" min="0" required></div>
                    </div>
                    <button type="submit" class="btn btn-success w-100">Cadastrar Produto</button>
                </form>
                <h4 class="mt-5 text-primary">Produtos em Estoque</h4>
                <ul id="listaProdutos" class="list-group mt-3"></ul>
            </div>
        </div>

        <div id="entrada-produtos" class="hidden card">
            <div class="card-body">
                <h2 class="card-title"> Registrar Entrada de Produtos</h2>
                <form id="entradaForm">
                    <div class="mb-3"><label>Código do Produto:</label><input type="text" class="form-control" id="codigoEntrada" required></div>
                    <div class="mb-3"><label>Quantidade a Adicionar:</label><input type="number" class="form-control" id="quantidadeEntrada" min="1" required></div>
                    <button type="submit" class="btn btn-primary w-100">Registrar Entrada</button>
                </form>
            </div>
        </div>

        <div id="saida-produtos" class="hidden card">
            <div class="card-body">
                <h2 class="card-title"> Registrar Saída de Produtos</h2>
                <form id="saidaForm">
                    <div class="mb-3"><label>Código do Produto:</label><input type="text" class="form-control" id="codigoSaida" required></div>
                    <div class="mb-3"><label>Quantidade a Remover:</label><input type="number" class="form-control" id="quantidadeSaida" min="1" required></div>
                    <button type="submit" class="btn btn-danger w-100">Registrar Saída</button>
                </form>
            </div>
        </div>

        <div id="consulta-estoque" class="hidden card">
            <div class="card-body">
                <h2 class="card-title"> Consulta Detalhada de Estoque</h2>
                <form id="consultaForm">
                    <div class="row">
                        <div class="col-md-6 mb-3"><label>Tipo de Consulta:</label>
                            <select class="form-control" id="tipoConsulta" required>
                                <option value="todos">Todos os Produtos</option>
                                <option value="codigo">Por Código</option>
                                <option value="categoria">Por Categoria</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3"><label>Valor (se aplicável):</label><input type="text" class="form-control" id="valorConsulta" placeholder="Ex: 'COD123' ou 'Eletrônicos'"></div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Consultar Estoque</button>
                </form>
                <h4 class="mt-5 text-primary">Resultado da Consulta</h4>
                <div id="resultadoConsulta" class="mt-3">Nenhum resultado para exibir.</div>
            </div>
        </div>

        <div id="relatorios" class="hidden card">
            <div class="card-body">
                <h2 class="card-title"> Geração de Relatórios</h2>
                <form id="relatorioForm">
                    <div class="mb-3"><label>Tipo de Relatório:</label>
                        <select class="form-control" id="tipoRelatorio" required>
                            <option value="baixo">Produtos com Estoque Baixo (&lt; 10)</option>
                            <option value="movimentacoes">Últimas 10 Movimentações</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Gerar Relatório</button>
                </form>
                <h4 class="mt-5 text-primary">Resultado do Relatório</h4>
                <div id="resultadoRelatorio" class="mt-3">Nenhum relatório gerado.</div>
            </div>
        </div>
    </div>

    <footer class="footer">
        Sistema de Controle de Estoque &copy; 2025 - Todos os direitos reservados a Café
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentUser = null;

        // Usuários pré-definidos (Administração e Funcionários)
        const users = {
            admin: { password: 'admin', role: 'admin' },
            funcionario: { password: 'func', role: 'funcionario' }
            // Usuários com role 'usuario' (ou promovidos) são adicionados dinamicamente
        };

        // --- Funções de Inicialização e Controle de Acesso ---

        /**
         * Carrega os usuários salvos no localStorage para o objeto 'users'.
         */
        function initializeUsers() {
            const pessoas = JSON.parse(localStorage.getItem('pessoas')) || [];
            
            // Remove usuários dinâmicos antigos antes de adicionar os novos do localStorage
            Object.keys(users).forEach(key => {
                // Mantém admin e funcionario pre-definidos, remove o resto
                if (key !== 'admin' && key !== 'funcionario') {
                    delete users[key];
                }
            });

            pessoas.forEach(p => {
                // Adiciona ou atualiza o usuário com a role armazenada
                users[p.nome] = { password: p.senha, role: p.role || 'usuario' };
            });
        }

        /**
         * Atualiza a visibilidade dos itens de navegação com base na role do usuário logado.
         */
        function updateNav() {
            // Oculta todos os itens inicialmente
            document.querySelectorAll('.nav-item a').forEach(item => item.classList.add('hidden'));

            if (currentUser) {
                const username = Object.keys(users).find(key => users[key] === currentUser);
                // Exibe itens de navegação apropriados
                document.querySelectorAll('.all-logged a').forEach(item => item.classList.remove('hidden'));
                document.querySelectorAll(`.${currentUser.role} a`).forEach(item => item.classList.remove('hidden'));
                document.getElementById('loggedUsername').textContent = username;
                document.getElementById('loggedUserRole').textContent = currentUser.role.toUpperCase();

                // Atualiza o Dashboard com dados
                updateDashboardData();
            }
        }

        /**
         * Oculta todas as páginas e exibe apenas a página solicitada.
         */
        function showPage(page) {
            document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById(page).classList.remove('hidden');

            // Atualiza listas ao navegar (para garantir que os dados mais recentes sejam exibidos)
            if (page === 'cadastro-pessoas') updateListaPessoas();
            if (page === 'cadastro-produtos') updateListaProdutos();
            if (page === 'cadastro-fornecedores') updateListaFornecedores();
            if (page === 'dashboard') updateDashboardData();
        }

        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            initializeUsers(); // Recarrega os usuários cadastrados antes de tentar o login

            if (users[username] && users[username].password === password) {
                currentUser = users[username];
                showPage('dashboard');
                updateNav();
            } else {
                alert('Credenciais inválidas! Verifique usuário e senha.');
            }
            this.reset();
        });

        function logout() {
            currentUser = null;
            showPage('login');
            updateNav();
        }
        
        // --- Funções de Dashboard ---
        function updateDashboardData() {
            const produtos = JSON.parse(localStorage.getItem('produtos')) || [];
            
            const prodCount = produtos.length;
            const stockTotal = produtos.reduce((sum, p) => sum + p.quantidade, 0);
            const lowStockCount = produtos.filter(p => p.quantidade < 10).length;

            document.getElementById('dashboardProdCount').textContent = prodCount;
            document.getElementById('dashboardStockTotal').textContent = stockTotal;
            document.getElementById('dashboardLowStock').textContent = lowStockCount;

            // Se o usuário não for Admin, ocultar a seção de gerenciamento de pessoas no menu, mas manter a tela.
            if (currentUser && currentUser.role !== 'admin') {
                 // Ocultar a seção de gerenciamento de pessoas (se for o caso)
                 document.querySelector('#cadastro-pessoas h4.text-primary').classList.add('hidden');
                 document.querySelector('#listaPessoas').classList.add('hidden');
            } else if (currentUser && currentUser.role === 'admin') {
                // Garante que esteja visível se for admin
                 document.querySelector('#cadastro-pessoas h4.text-primary').classList.remove('hidden');
                 document.querySelector('#listaPessoas').classList.remove('hidden');
            }
        }

        // --- Funções de Promoção/Gerenciamento de Usuários ---

        /**
         * Promove ou muda a função de um usuário dinâmico.
         */
        function promoteUser(userName, newRole) {
            if (currentUser.role !== 'admin') {
                alert('Apenas administradores podem gerenciar o acesso de usuários.');
                return;
            }

            // Impede a alteração da role dos usuários padrões 'admin' e 'funcionario'
            if (userName === 'admin' || userName === 'funcionario') {
                alert('Não é possível alterar a função dos usuários padrão (admin, funcionario).');
                return;
            }

            let pessoas = JSON.parse(localStorage.getItem('pessoas')) || [];
            const pessoaIndex = pessoas.findIndex(p => p.nome === userName);

            if (pessoaIndex > -1) {
                pessoas[pessoaIndex].role = newRole;
                localStorage.setItem('pessoas', JSON.stringify(pessoas));
                
                // Atualiza o estado do aplicativo
                initializeUsers();
                updateListaPessoas();
                updateNav(); 
                
                alert(`Usuário "${userName}" promovido para a função: ${newRole.toUpperCase()}! Ele deverá fazer login novamente para que o novo acesso seja aplicado.`);
            } else {
                alert('Erro: Usuário não encontrado na lista de pessoas cadastradas.');
            }
        }


        // --- Funções de Listagem e Persistência (LocalStorage) ---

        // 1. Pessoas (Usuários Simples)
        function updateListaPessoas() {
            const pessoas = JSON.parse(localStorage.getItem('pessoas')) || [];
            const listaPessoas = document.getElementById('listaPessoas');
            listaPessoas.innerHTML = ''; // Limpa a lista antes de preencher

            // Adiciona usuários padrão ao topo da lista (apenas para visualização do admin)
            if (currentUser && currentUser.role === 'admin') {
                ['admin', 'funcionario'].forEach(userKey => {
                    const user = users[userKey];
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center bg-light text-muted';
                    li.innerHTML = `<div>
                        <strong>${userKey}</strong> (Função: <span class="badge bg-danger">${user.role.toUpperCase()}</span>) - *Usuário Padrão*
                        </div>
                        <div>
                        <button class="btn btn-sm btn-outline-danger ms-2" disabled>Acesso Fixo</button>
                        </div>`;
                    listaPessoas.appendChild(li);
                });
            }

            // Adiciona usuários dinâmicos (cadastrados)
            pessoas.forEach(p => {
                const currentRole = p.role || 'usuario';
                let promoteButtons = '';
                
                if (currentUser && currentUser.role === 'admin') {
                    // Botão para tornar os corno em ADMIN
                    if (currentRole !== 'admin') {
                        promoteButtons += `<button class="btn btn-sm btn-danger ms-2" onclick="promoteUser('${p.nome}', 'admin')">Tornar Admin</button>`;
                    }

                    // Botão para tornar os corno em FUNCIONARIO
                    if (currentRole !== 'funcionario' && currentRole !== 'admin') {
                        promoteButtons += `<button class="btn btn-sm btn-info ms-2" onclick="promoteUser('${p.nome}', 'funcionario')">Tornar Funcionário</button>`;
                    }

                    // Botão para tornar os corno em USUARIO (rebaixar)
                    if (currentRole !== 'usuario') {
                        promoteButtons += `<button class="btn btn-sm btn-secondary ms-2" onclick="promoteUser('${p.nome}', 'usuario')">Rebaixar p/ Usuário</button>`;
                    }
                }

                const li = document.createElement('li');
                li.className = 'list-group-item d-flex justify-content-between align-items-center';
                li.innerHTML = `<div>
                    <strong>${p.nome}</strong> (Função: <span class="badge ${currentRole === 'usuario' ? 'bg-secondary' : 'bg-success'}">${currentRole.toUpperCase()}</span>) - Idade: ${p.idade}
                    </div>
                    <div>
                    ${promoteButtons}
                    </div>`;
                listaPessoas.appendChild(li);
            });

            // Se for funcionário ou usuário simples, remove os botões de promoção
            if (currentUser && currentUser.role !== 'admin') {
                listaPessoas.querySelectorAll('.btn').forEach(btn => btn.remove());
            }

            // Esconde a lista se não for admin
            if (currentUser && currentUser.role !== 'admin') {
                document.querySelector('#cadastro-pessoas h4').classList.add('hidden');
            } else if (document.querySelector('#cadastro-pessoas h4')) {
                 document.querySelector('#cadastro-pessoas h4').classList.remove('hidden');
            }
        }

        document.getElementById('cadastroForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const nome = document.getElementById('nome').value.trim();
            const idade = parseInt(document.getElementById('idade').value);
            const senha = document.getElementById('senha').value;
            
            initializeUsers(); // Garante que a lista de usuários 'users' esteja atualizada

            if (idade <= 0 || senha.length < 6 || users[nome]) {
                if (users[nome]) alert('Usuário já cadastrado (nome reservado)!');
                else alert('Dados inválidos: Idade deve ser positiva e Senha >= 6 caracteres.');
                return;
            }
            
            // NOVO: Adiciona a role padrão 'usuario'
            const pessoa = { nome, idade, senha, role: 'usuario' }; 
            let pessoas = JSON.parse(localStorage.getItem('pessoas')) || [];
            pessoas.push(pessoa);
            localStorage.setItem('pessoas', JSON.stringify(pessoas));
            
            // Adiciona a pessoa ao objeto 'users' em tempo real
            initializeUsers(); 
            updateListaPessoas();
            this.reset();
            alert(`Pessoa "${nome}" cadastrada com sucesso como usuário simples!`);
            
            if (currentUser && currentUser.role === 'admin') {
                updateNav();
            }
        });

        // 2. Fornecedores
        function updateListaFornecedores() {
            const fornecedores = JSON.parse(localStorage.getItem('fornecedores')) || [];
            document.getElementById('listaFornecedores').innerHTML = fornecedores.map(f => 
                `<li class="list-group-item">
                    <div>
                        <strong>${f.nome}</strong> | CNPJ: ${f.cnpj}
                    </div>
                    <small class="text-muted">Email: ${f.email || 'N/A'} | Telefone: ${f.telefone || 'N/A'}</small>
                </li>`
            ).join('');
        }

        document.getElementById('fornecedorForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const fornecedor = {
                nome: document.getElementById('nomeFornecedor').value,
                cnpj: document.getElementById('cnpjFornecedor').value,
                telefone: document.getElementById('telefoneFornecedor').value,
                email: document.getElementById('emailFornecedor').value
            };
            let fornecedores = JSON.parse(localStorage.getItem('fornecedores')) || [];
            if (fornecedores.some(f => f.cnpj === fornecedor.cnpj)) {
                alert('Erro: Já existe um fornecedor com este CNPJ!');
                return;
            }
            fornecedores.push(fornecedor);
            localStorage.setItem('fornecedores', JSON.stringify(fornecedores));
            updateListaFornecedores();
            this.reset();
            alert('Fornecedor cadastrado com sucesso!');
        });
        
        // 3. Produtos
        function updateListaProdutos() {
            const produtos = JSON.parse(localStorage.getItem('produtos')) || [];
            document.getElementById('listaProdutos').innerHTML = produtos.map(p => 
                `<li class="list-group-item ${p.quantidade < 10 ? 'border-danger' : ''}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${p.nome}</strong> (${p.codigo}) 
                            <span class="badge bg-secondary ms-2">${p.categoria}</span>
                        </div>
                        <div>
                            Qtd: <strong class="${p.quantidade < 10 ? 'text-danger' : 'text-success'}">${p.quantidade}</strong> 
                            | Preço: R$ ${p.preco.toFixed(2)}
                            ${p.quantidade < 10 ? '<span class="badge bg-danger ms-2">BAIXO ESTOQUE</span>' : ''}
                        </div>
                    </div>
                </li>`
            ).join('');
        }

        document.getElementById('produtoForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const codigo = document.getElementById('codigoProd').value.trim();
            let produtos = JSON.parse(localStorage.getItem('produtos')) || [];

            if (produtos.some(p => p.codigo === codigo)) {
                alert('Erro: Já existe um produto com este código!');
                return;
            }

            const produto = {
                nome: document.getElementById('nomeProd').value,
                codigo: codigo,
                categoria: document.getElementById('categoria').value,
                quantidade: parseInt(document.getElementById('quantidade').value),
                preco: parseFloat(document.getElementById('preco').value)
            };
            
            produtos.push(produto);
            localStorage.setItem('produtos', JSON.stringify(produtos));
            updateListaProdutos();
            this.reset();
            alert('Produto cadastrado com sucesso!');
            updateDashboardData();
        });

        // 4. Movimentações
        function registrarMovimentacao(codigo, tipo, quantidade) {
            let movimentacoes = JSON.parse(localStorage.getItem('movimentacoes')) || [];
            movimentacoes.push({ 
                codigo, 
                tipo, 
                quantidade, 
                data: new Date().toLocaleString(),
                usuario: Object.keys(users).find(key => users[key] === currentUser) || 'Desconhecido'
            });
            localStorage.setItem('movimentacoes', JSON.stringify(movimentacoes));
        }

        document.getElementById('entradaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const codigo = document.getElementById('codigoEntrada').value;
            const quantidade = parseInt(document.getElementById('quantidadeEntrada').value);
            let produtos = JSON.parse(localStorage.getItem('produtos')) || [];
            const produto = produtos.find(p => p.codigo === codigo);
            
            if (produto && quantidade > 0) {
                produto.quantidade += quantidade;
                localStorage.setItem('produtos', JSON.stringify(produtos));
                registrarMovimentacao(codigo, 'entrada', quantidade);
                alert(`Entrada de ${quantidade} unidades do produto ${codigo} registrada!`);
                updateListaProdutos();
                updateDashboardData();
            } else {
                alert(produto ? 'A quantidade deve ser positiva.' : 'Produto não encontrado!');
            }
            this.reset();
        });

        document.getElementById('saidaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const codigo = document.getElementById('codigoSaida').value;
            const quantidade = parseInt(document.getElementById('quantidadeSaida').value);
            let produtos = JSON.parse(localStorage.getItem('produtos')) || [];
            const produto = produtos.find(p => p.codigo === codigo);

            if (produto && quantidade > 0) {
                if (produto.quantidade >= quantidade) {
                    produto.quantidade -= quantidade;
                    localStorage.setItem('produtos', JSON.stringify(produtos));
                    registrarMovimentacao(codigo, 'saida', quantidade);
                    alert(`Saída de ${quantidade} unidades do produto ${codigo} registrada!`);
                    updateListaProdutos();
                    updateDashboardData();
                } else {
                    alert(`Quantidade insuficiente! Estoque atual: ${produto.quantidade}.`);
                }
            } else {
                alert(produto ? 'A quantidade deve ser positiva.' : 'Produto não encontrado!');
            }
            this.reset();
        });


        // --- Consulta e Relatórios ---

        document.getElementById('consultaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const tipo = document.getElementById('tipoConsulta').value;
            const valor = document.getElementById('valorConsulta').value.trim().toLowerCase();
            const produtos = JSON.parse(localStorage.getItem('produtos')) || [];
            let resultados = [];
            
            if (tipo === 'codigo' && valor) {
                resultados = produtos.filter(p => p.codigo.toLowerCase() === valor);
            } else if (tipo === 'categoria' && valor) {
                resultados = produtos.filter(p => p.categoria.toLowerCase() === valor);
            } else if (tipo === 'todos') {
                resultados = produtos;
            }

            const htmlResultado = resultados.length > 0
                ? resultados.map(p => 
                    `**${p.nome}** (${p.codigo}) | Categoria: ${p.categoria} | Qtd: **${p.quantidade}** | Preço: R$ ${p.preco.toFixed(2)}`
                ).join('<br>')
                : '<span class="text-muted">Nenhum resultado encontrado.</span>';

            document.getElementById('resultadoConsulta').innerHTML = htmlResultado;
        });

        document.getElementById('relatorioForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const tipo = document.getElementById('tipoRelatorio').value;
            const produtos = JSON.parse(localStorage.getItem('produtos')) || [];
            const movimentacoes = JSON.parse(localStorage.getItem('movimentacoes')) || [];
            let relatorio = [];
            
            if (tipo === 'baixo') {
                relatorio = produtos
                    .filter(p => p.quantidade < 10)
                    .map(p => `<span class="text-danger">⚠️ **${p.nome}** (${p.codigo}) - Qtd: **${p.quantidade}** (Necessita de reposição!)</span>`);
            } else if (tipo === 'movimentacoes') {
                relatorio = movimentacoes
                    .slice(-10) 
                    .reverse() 
                    .map(m => {
                        const style = m.tipo === 'entrada' ? 'text-success' : 'text-danger';
                        const icon = m.tipo === 'entrada' ? '⬆️' : '⬇️';
                        return `[${m.data}] | Tipo: <strong class="${style}">${icon} ${m.tipo.toUpperCase()}</strong> | Produto: ${m.codigo} | Qtd: ${m.quantidade} | Por: ${m.usuario}`;
                    });
            }
            
            const htmlRelatorio = relatorio.length > 0
                ? relatorio.join('<br>')
                : '<span class="text-muted">Nenhum dado encontrado para este relatório.</span>';

            document.getElementById('resultadoRelatorio').innerHTML = htmlRelatorio;
        });


        // --- Inicialização da Aplicação ---
        initializeUsers(); // Carrega usuários simples ao iniciar
        showPage('login'); // Começa na tela de login
        updateNav(); // Garante que a navegação esteja oculta
    </script>
</body>
</html>
